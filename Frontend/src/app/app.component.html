<div class="container my-5">


<!-- Toast Container -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
  <div *ngFor="let toast of toastMessages" class="toast show mb-2" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Notification</strong>
      <small class="text-muted">Just now</small>
      <button type="button" class="btn-close" (click)="removeToast(toast)" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      {{ toast }}
    </div>
  </div>
</div>


    <!-- Title -->
    <h1 class="mb-4 text-center">TeamSync</h1>


    <!-- LOGIN / REGISTER -->

    <!--This <div> is only shown if the user is not logged in.-->

    <div *ngIf="!isLoggedIn" class="card mb-4">

      <!--If showRegister is true ‚Üí displays Register.Else ‚Üí displays Login. -->
      <div class="card-header">{{ showRegister ? 'Register' : 'Login' }}</div> 
    
      <div class="card-body">
        <!--If showRegister is true it will execute the register() function else it will execute login function -->
        <form (ngSubmit)="showRegister ? register() : login()" class="row g-3">

          <div class="col-md-4">
           
            <input type="email" [(ngModel)]="authForm.email" name="email" class="form-control" placeholder="Email" required />
          </div>
          <div class="col-md-4">
            <input type="password" [(ngModel)]="authForm.password" name="password" class="form-control" placeholder="Password" required />
          </div>

           <!-- Role input (only for registration) -->
            <div class="col-md-4" *ngIf="showRegister">
              <input type="text" [(ngModel)]="authForm.role" name="role" class="form-control" placeholder="Role" required />
            </div>

            <!-- Department input (only for registration) -->
            <div class="col-md-4" *ngIf="showRegister">
              <input type="text" [(ngModel)]="authForm.department" name="department" class="form-control" placeholder="Department" required />
            </div>
            <!-- name -->
            <div class="col-md-4" *ngIf="showRegister">
              <input type="text" [(ngModel)]="authForm.name" name="name" class="form-control" placeholder="Name" />
            </div>


          <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100">{{ showRegister ? 'Register' : 'Login' }}</button>
          </div>
        </form>
        <div class="mt-3 text-center">
          <a href="#" (click)="toggleAuthMode()">
            {{ showRegister ? 'Already have an account? Login' : 'New here? Register' }}
          </a>
        </div>
      </div>
    </div>


    





    <!-- LOGGED IN DASHBOARD . This will show if user is logged in-->
    <div *ngIf="isLoggedIn">

     
      <!-- User Info Card -->
      <div class="card mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5>Welcome, {{ currentUserName }}!</h5>
            <p><strong>User ID:</strong> {{ currentUserId }}</p>
            <p><strong>Email:</strong> {{ userEmail }}</p>
          </div>
          <button class="btn btn-outline-danger" (click)="logout()">Logout</button>
        </div>
      </div>

      <div class="card mb-4">
  <div class="card-header">
    <h5>My Projects</h5>
  </div>
  <div class="card-body" *ngIf="userProjects.length; else noProjects">
    <ul class="list-group">
      <li *ngFor="let project of userProjects" class="list-group-item">
        <!-- {{ project.name }} -id ({{ project.id }}) -->
          {{ project.name }}
       
      </li>
    </ul>
  </div>
  <ng-template #noProjects>
    <p>No projects assigned to you.</p>
  </ng-template>
</div>






      <!-- Project Form -->
      <div class="card mb-4">
        <div class="card-header">{{ editingProject ? 'Edit Project' : 'Add New Project' }}</div>
        <div class="card-body">
          <form (ngSubmit)="saveProject()" class="row g-3">
            <div class="col-md-3">
              <input type="text" [(ngModel)]="projectForm.name" name="name" class="form-control" placeholder="Project Name" required />
            </div>
            <div class="col-md-3">
              <input type="text" [(ngModel)]="projectForm.description" name="description" class="form-control" placeholder="Description" />
            </div>
            <!-- <div class="col-md-3">
              <input type="text" [(ngModel)]="projectForm.membersStr" name="members" class="form-control" placeholder="Members (comma-separated)" />
            </div> -->

            <!--  New dropdown for assigned user -->
            <div class="col-md-3">
                <select [(ngModel)]="projectForm.assignedUserId" name="assignedUserId" class="form-select">
                <option value="">-- Select User --</option>
                <option *ngFor="let user of users" [value]="user.Id">
                   {{ user.Name }} (  {{ user.Email }} )
                </option>
                </select>

                <button type="button" class="btn btn-primary" (click)="addUserId()">Add Member</button>
            </div>
             

            <div class="col-md-3">
              <button type="submit" class="btn btn-primary">{{ editingProject ? 'Update' : 'Add' }}</button>
              <button type="button" *ngIf="editingProject" (click)="cancelProjectEdit()" class="btn btn-secondary ms-2">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Projects Table -->
      <div class="card">
        <div class="card-header">All Projects</div>
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Created By</th>
                <th>Team Members</th>
                <th>Team Chat</th>
                <th>Tasks</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let project of projects">
                <td>{{ project.name }}</td>
                <td>{{ project.description }}</td>
                <td> {{ project.createdBy }}</td>
                
                <!-- <td>{{ project.userIds }}</td> -->
                <td>
                  <ng-container *ngIf="project.userIds && project.userIds.length > 0; else noMembers">
                    <span *ngFor="let id of project.userIds; let i = index">
                      {{ getUserNameById(id) }}<span *ngIf="i < project.userIds.length - 1">, </span>
                    </span>
                  </ng-container>
                  <ng-template #noMembers>‚Äî</ng-template>
                </td>
               
                 
                <td><button class="btn btn-sm btn-primary ms-1" (click)="openTeamChat(project.id)  ">Chat</button></td>

                <!-- Tasks Column -->
                <td class="tasks-column">
                        <div *ngFor="let task of project.tasks" class="d-flex align-items-center mb-1">
                          
                          <!-- Check if this task is being edited -->
                          <div *ngIf="editingTask && editingTask.id === task.id" class="d-flex w-100 gap-1">
                            <input type="text" class="form-control form-control-sm" [(ngModel)]="editingTask.title" />
                            <input type="text" class="form-control form-control-sm" [(ngModel)]="editingTask.assignee" />
                            <select class="form-select form-select-sm" [(ngModel)]="editingTask.status">
                              <option>Pending</option>
                              <option>In Progress</option>
                              <option>Completed</option>
                            </select>
                            <button class="btn btn-sm btn-success" (click)="updateTask()">‚úîÔ∏è</button>
                            <button class="btn btn-sm btn-secondary" (click)="cancelTaskEdit()">‚úñÔ∏è</button>
                          </div>

                          <!-- Normal display if not editing -->
                          <div *ngIf="!editingTask || editingTask.id !== task.id" class="d-flex align-items-center w-100">
                            <span class="badge bg-info text-dark me-2">{{ task.status }}</span>
                            <span class="me-auto">{{ task.title }} ({{ task.assignee }})</span>
                            <button class="btn btn-sm btn-warning me-1" (click)="editTask(task, project.id)">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" (click)="deleteTask(task.id)">üóëÔ∏è</button>
                          </div>

                        </div>
                      

                  <!-- Add Task Inputs -->
                  <div class="input-group input-group-sm mt-2">
                    <input type="text" class="form-control" placeholder="Title" [(ngModel)]="newTaskTitle[project.id]" name="taskTitle-{{project.id}}" />
                    <input type="text" class="form-control" placeholder="Assignee" [(ngModel)]="newTaskAssignee[project.id]" name="taskAssignee-{{project.id}}" />
                    <input type="date" class="form-control" [(ngModel)]="newTaskDueDate[project.id]" name="taskDue-{{project.id}}" />
                    <button class="btn btn-primary" (click)="createTask(project.id)">Add</button>
                  </div>
                </td>
                

            

                <!-- Project Actions -->
                <td>
                  <button class="btn btn-sm btn-success" (click)="editProject(project)">Edit</button>
                  <button class="btn btn-sm btn-danger ms-1" (click)="deleteProject(project.id)">Delete</button>

                  
                </td>
              </tr>


            

            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>


  <!-- Team Chat Modal -->
<div class="modal fade show" tabindex="-1" style="display: block;" *ngIf="openChatProjectId">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Team Chat - {{ getProjectNameById(openChatProjectId) }}</h5>
        <button type="button" class="btn-close" (click)="openChatProjectId = null"></button>
      </div>

      <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
           <div *ngFor="let msg of getMessagesForProject(openChatProjectId)">
                 <strong>{{ msg.senderName }}: </strong> {{msg.message}}
         
      </div>
        
        <ng-template #noMessages>
          <em>No messages yet</em>
        </ng-template>
      </div>

      <div class="modal-footer">
        <input type="text" class="form-control me-2"
               [(ngModel)]="newProjectMessage[openChatProjectId]" 
               placeholder="Type a message..." /> 
        <button class="btn btn-primary" (click)="sendProjectMessage(openChatProjectId!)">Send</button>
        <button class="btn btn-secondary" (click)="openChatProjectId = null">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop -->
<div class="modal-backdrop fade show" *ngIf="openChatProjectId"></div>

